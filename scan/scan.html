<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Scan QR Check-in</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body {
  background:#0f0c0a;
  color:#d4af6a;
  font-family:Arial, sans-serif;
  text-align:center;
  padding:20px;
}
h2 { margin-bottom:5px; }
#reader {
  width:320px;
  margin:20px auto;
  border:3px solid #d4af6a;
  border-radius:14px;
}
#badge {
  margin-top:20px;
  padding:14px;
  font-size:1.1rem;
  border-radius:10px;
  display:none;
}
.success { background:#1e7f43; color:#fff; }
.duplicate { background:#a67c00; color:#000; }
.error { background:#7f1e1e; color:#fff; }
</style>
</head>

<body>

<h2>SCAN QR TAMU</h2>
<p>Arahkan kamera ke QR undangan</p>

<div id="reader"></div>
<div id="badge"></div>

<!-- SOUND -->
<audio id="soundSuccess" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>
<audio id="soundDuplicate" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>
<audio id="soundError" src="https://actions.google.com/sounds/v1/alarms/alarm_clock.ogg"></audio>

<script>
/* =============================
   KONFIGURASI
============================= */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw8hlNUj25__RM2eKvzSA6lgfbXRsiOmR6aUdvCaRTDF9MH6XGek02EAMyqvMYOOt-6eQ/exec";

let locked = false;

/* =============================
   BADGE UI
============================= */
function showBadge(text, type){
  const b = document.getElementById("badge");
  b.className = type;
  b.innerText = text;
  b.style.display = "block";
}

/* =============================
   SOUND + VIBRATE
============================= */
function playSuccess(){
  document.getElementById("soundSuccess").play();
  navigator.vibrate?.(150);
}

function playDuplicate(){
  document.getElementById("soundDuplicate").play();
  navigator.vibrate?.(400);
}

function playError(){
  document.getElementById("soundError").play();
  navigator.vibrate?.([200,100,200]);
}

/* =============================
   CHECK-IN
============================= */
function sendCheckin(token){
  if(locked) return;
  locked = true;

  showBadge("⏳ Memproses...", "duplicate");

  const body = new URLSearchParams({
    mode: "checkin",
    token: token
  });

  fetch(SCRIPT_URL, {
    method: "POST",
    body
  })
  .then(res => res.text())
  .then(res => {
    if(res === "success"){
      playSuccess();
      showBadge("✔ HADIR", "success");
    } 
    else if(res === "duplicate"){
      playDuplicate();
      showBadge("⚠ SUDAH CHECK-IN", "duplicate");
    } 
    else {
      playError();
      showBadge("❌ DATA TIDAK DITEMUKAN", "error");
    }
  })
  .catch(() => {
    playError();
    showBadge("❌ GAGAL KONEKSI", "error");
  })
  .finally(() => {
    setTimeout(() => locked = false, 2500);
  });
}

/* =============================
   SCAN SUCCESS
============================= */
function onScanSuccess(text){
  sendCheckin(text.trim());
}

/* =============================
   INIT SCANNER
============================= */
const scanner = new Html5Qrcode("reader");
scanner.start(
  { facingMode:"environment" },
  { fps:10, qrbox:250 },
  onScanSuccess
);
</script>

</body>
</html>
