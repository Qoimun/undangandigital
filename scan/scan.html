<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Vendor Scan QR ‚Äî Wedding Check-in</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      background: #0f0c0a;
      color: #d4af6a;
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 10px;
    }

    #reader {
      width: 320px;
      margin: 20px auto;
      border: 3px solid #d4af6a;
      border-radius: 12px;
      overflow: hidden;
    }

    #status {
      margin-top: 20px;
      font-size: 1rem;
      padding: 12px;
      border-radius: 8px;
    }

    .success { background: #1e7f43; color: #fff; }
    .duplicate { background: #a67c00; color: #000; }
    .error { background: #7f1e1e; color: #fff; }

    .offline {
      margin-top: 15px;
      font-size: 0.8rem;
      color: #aaa;
    }
  </style>
</head>

<body>

  <h1>SCAN QR TAMU</h1>
  <p>Arahkan kamera ke QR Undangan</p>

  <div id="reader"></div>
  <div id="status"></div>
  <div class="offline" id="offlineInfo"></div>

<script>
/* ==============================
   KONFIGURASI
================================ */
const SHEET_URL = "https://script.google.com/macros/s/AKfycbyaR6LpmtYm4Hju5_rAl0X-wXK-J63HYWBzYhyrPngZWT3G_AH1HIpqGjEjC4EHfto1VQ/exec";
const OFFLINE_KEY = "offline_checkin_queue";

/* ==============================
   STATUS UI
================================ */
function showStatus(msg, type) {
  const el = document.getElementById("status");
  el.className = type;
  el.innerText = msg;
}

/* ==============================
   OFFLINE QUEUE
================================ */
function saveOffline(token) {
  const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || "[]");
  q.push({ token, time: Date.now() });
  localStorage.setItem(OFFLINE_KEY, JSON.stringify(q));
  document.getElementById("offlineInfo").innerText =
    "‚ö† Offline mode ‚Äî data disimpan lokal (" + q.length + ")";
}

/* ==============================
   SYNC OFFLINE DATA
================================ */
function syncOffline() {
  const q = JSON.parse(localStorage.getItem(OFFLINE_KEY) || "[]");
  if (!q.length) return;

  q.forEach(item => {
    sendCheckin(item.token, true);
  });

  localStorage.removeItem(OFFLINE_KEY);
  document.getElementById("offlineInfo").innerText = "";
}

/* ==============================
   KIRIM CHECK-IN
================================ */
function sendCheckin(token, silent=false) {
  const body = new URLSearchParams({
    mode: "checkin",
    token: token
  });

  fetch(SHEET_URL, {
    method: "POST",
    body
  })
  .then(res => res.text())
  .then(res => {
    if (!silent) {
      if (res === "success") {
        showStatus("‚úî Check-in berhasil", "success");
      } else if (res === "duplicate") {
        showStatus("‚ö† Sudah check-in", "duplicate");
      } else {
        showStatus("‚ùå Data tidak ditemukan", "error");
      }
    }
  })
  .catch(() => {
    saveOffline(token);
    showStatus("üì¥ Offline ‚Äî disimpan sementara", "duplicate");
  });
}

/* ==============================
   SCAN SUCCESS
================================ */
function onScanSuccess(decodedText) {
  showStatus("‚è≥ Memproses...", "duplicate");
  sendCheckin(decodedText);
}

/* ==============================
   INIT SCANNER
================================ */
const scanner = new Html5Qrcode("reader");

scanner.start(
  { facingMode: "environment" },
  { fps: 10, qrbox: 250 },
  onScanSuccess
);

/* ==============================
   AUTO SYNC SAAT ONLINE
================================ */
window.addEventListener("online", syncOffline);
</script>

</body>
</html>
