<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard Panitia</title>

    <style>
      body {
        font-family: Arial;
        background: #0e0c0a;
        color: #f5f2eb;
        padding: 20px;
      }
      h1 {
        color: #d4af6a;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin: 20px 0;
      }
      .card {
        background: #1a1714;
        padding: 20px;
        border: 1px solid #d4af6a;
        text-align: center;
      }
      select,
      button,
      input {
        padding: 10px;
        margin: 10px 0;
        background: #111;
        color: #fff;
        border: 1px solid #d4af6a;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #333;
        padding: 10px;
      }
      th {
        background: #1a1714;
        color: #d4af6a;
      }
      tr:nth-child(even) {
        background: #111;
      }
      #login {
        max-width: 300px;
        margin: 80px auto;
        text-align: center;
      }
    </style>
  </head>

  <body>
    <!-- LOGIN -->
    <div id="login">
      <h1>Dashboard Panitia</h1>
      <p>Masukkan PIN</p>
      <input id="pin" type="password" placeholder="PIN Panitia" />
      <br />
      <button id="btnLogin">MASUK</button>
      <p id="error"></p>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" style="display: none">
      <h1>Dashboard Panitia</h1>
      <p>Realtime Daftar Hadir</p>

      <div class="stats">
        <div class="card">
          <h2 id="total">0</h2>
          Total RSVP
        </div>
        <div class="card">
          <h2 id="hadir">0</h2>
          Hadir
        </div>
        <div class="card">
          <h2 id="tidak">0</h2>
          Tidak Hadir
        </div>
        <div class="card">
          <h2 id="checkin">0</h2>
          Check-in
        </div>
      </div>

      <select id="filter" onchange="render()">
        <option value="all">Semua</option>
        <option value="Hadir">Hadir</option>
        <option value="Tidak Hadir">Tidak Hadir</option>
        <option value="checkin">Sudah Check-in</option>
      </select>

      <button onclick="exportCSV()">â¬‡ Export Excel</button>

      <table>
        <thead>
          <tr>
            <th>Nama</th>
            <th>Status</th>
            <th>Check-in</th>
          </tr>
        </thead>
        <tbody id="list"></tbody>
      </table>
    </div>

    <script>
      const SHEET_URL =
        "https://script.google.com/macros/s/AKfycbz1pohlmX41ox6VrUvWHeW2J0LEk7x8XhZSEgBIgUlQyZven-BxVAL0sioStbb4NwsHaQ/exec";
      let PIN = "";
      let data = [];

      function login() {
        PIN = document.getElementById("pin").value.trim();
        if (!PIN) {
          document.getElementById("error").innerText = "PIN kedah dipun isi";
          return;
        }

        fetch(SHEET_URL + "?pin=" + PIN)
          .then((res) => res.json())
          .then((res) => {
            if (res.status !== "ok") {
              document.getElementById("error").innerText = "PIN salah";
              return;
            }

            document.getElementById("login").style.display = "none";
            document.getElementById("dashboard").style.display = "block";

            data = res.data;
            updateStats();
            render();
            setInterval(loadData, 5000);
          })
          .catch(() => {
            document.getElementById("error").innerText =
              "Gagal nyambung server";
          });
      }

      document.getElementById("pin").addEventListener("keypress", (e) => {
        if (e.key === "Enter") login();
      });

      function loadData() {
        fetch(SHEET_URL + "?pin=" + PIN)
          .then((res) => res.json())
          .then((res) => {
            if (res.status === "ok") {
              data = res.data;
              updateStats();
              render();
            }
          });
      }

      function updateStats() {
        document.getElementById("total").innerText = data.length;
        document.getElementById("hadir").innerText = data.filter(
          (d) => d.hadir === "Hadir"
        ).length;
        document.getElementById("tidak").innerText = data.filter(
          (d) => d.hadir === "Tidak Hadir"
        ).length;
        document.getElementById("checkin").innerText = data.filter(
          (d) => d.checkin
        ).length;
      }

      function render() {
        const filter = document.getElementById("filter").value;
        const tbody = document.getElementById("list");
        tbody.innerHTML = "";
        data.forEach((d) => {
          if (filter === "Hadir" && d.hadir !== "Hadir") return;
          if (filter === "Tidak Hadir" && d.hadir !== "Tidak Hadir") return;
          if (filter === "checkin" && !d.checkin) return;
          tbody.innerHTML += `
      <tr>
        <td>${d.nama}</td>
        <td>${d.hadir}</td>
        <td>${d.checkin || "-"}</td>
      </tr>`;
        });
      }

      function exportCSV() {
        let csv = "Nama,Status,Check-in\n";
        data.forEach((d) => {
          csv += `"${d.nama}","${d.hadir}","${d.checkin || ""}"\n`;
        });
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "daftar_hadir.csv";
        a.click();
      }
      document.getElementById("btnLogin").addEventListener("click", login);
    </script>
  </body>
</html>
